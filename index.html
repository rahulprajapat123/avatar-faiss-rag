<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ü§ñ AI Avatar Assistant</title>
  
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 1200px;
      width: 95%;
      height: 90vh;
      display: flex;
      overflow: hidden;
    }

    .video-section {
      flex: 1;
      background: #000;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #avatarVideo {
      width: 100%;
      height: 100%;
      background: transparent;
      object-fit: cover;
      display: none;
    }

    #audioElement {
      display: none;
    }

    .status-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #dc3545;
      transition: all 0.3s ease;
    }

    .status-dot.active {
      background: #22c55e;
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 1.2em;
      color: white;
      z-index: 1;
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(0,0,0,0.8);
    }

    .video-placeholder.hidden {
      display: none;
    }

    .video-placeholder .icon {
      font-size: 5em;
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .click-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      flex-direction: column;
      gap: 20px;
    }

    .click-overlay.active {
      display: flex;
    }

    .click-prompt {
      background: white;
      color: #1f2937;
      padding: 50px 70px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .click-prompt h2 {
      margin: 0 0 15px 0;
      font-size: 36px;
      color: #667eea;
    }

    .click-prompt p {
      margin: 0;
      font-size: 18px;
      color: #6b7280;
      line-height: 1.6;
    }

    .click-prompt .emoji {
      font-size: 64px;
      margin-bottom: 20px;
      display: block;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .loader {
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 5px solid white;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
      display: none;
    }

    .loader.active {
      display: block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 30px;
      background: white;
    }

    .header {
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .header .subtitle {
      color: #6b7280;
      font-size: 14px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f9fafb;
      border-radius: 12px;
      margin-bottom: 20px;
      min-height: 0;
    }

    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .message {
      padding: 12px 15px;
      border-radius: 12px;
      max-width: 85%;
      word-wrap: break-word;
      animation: slideIn 0.3s ease-out;
      line-height: 1.5;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.avatar {
      background: white;
      color: #333;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border: 1px solid #e5e7eb;
    }

    .message.system {
      background: #fff3cd;
      color: #856404;
      align-self: center;
      font-size: 0.9em;
      font-style: italic;
      text-align: center;
      border-radius: 20px;
      max-width: 70%;
    }

    .message-time {
      font-size: 0.75em;
      opacity: 0.7;
      margin-top: 5px;
      display: block;
    }

    .input-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-input {
      display: flex;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 14px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s;
    }

    .chat-input input:focus {
      border-color: #667eea;
    }

    .button-row {
      display: flex;
      gap: 12px;
    }

    .chat-input button {
      padding: 14px 32px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s;
    }

    .chat-input button:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .chat-input button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn {
      padding: 14px 32px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s;
      flex: 1;
    }

    .btn:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    #speakBtn {
      background: #10b981;
    }

    #speakBtn:hover:not(:disabled) {
      background: #059669;
    }

    #speakBtn.recording {
      background: #ef4444;
      animation: pulse-red 1s infinite;
    }

    #stopBtn {
      background: #ef4444;
    }

    #stopBtn:hover:not(:disabled) {
      background: #dc2626;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    @keyframes pulse-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
        height: auto;
        min-height: 90vh;
      }

      .video-section {
        min-height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="video-section">
      <video id="avatarVideo" autoplay playsinline muted></video>
      <audio id="audioElement"></audio>
      
      <div class="click-overlay" id="clickOverlay">
        <div class="click-prompt">
          <span class="emoji">üîä</span>
          <h2>Enable Audio</h2>
          <p>Click anywhere to start the avatar<br/>with audio enabled</p>
        </div>
      </div>
      
      <div id="videoPlaceholder" class="video-placeholder">
        <div class="loader" id="loader"></div>
        <div class="icon">üé≠</div>
        <h2 id="placeholderTitle">Avatar Initializing...</h2>
        <p id="placeholderText">Please wait while we connect...</p>
      </div>
      
      <div class="status-badge">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
      </div>
    </div>

    <div class="chat-section">
      <div class="header">
        <h1>üéØ HPE ProLiant AI Assistant</h1>
        <p class="subtitle">‚ö° Heygen + Voiceflow + RAG </p>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message system">
          üëã Initializing avatar... Please wait.
        </div>
      </div>

      <div class="input-section">
        <div class="chat-input">
          <input 
            type="text" 
            id="chatInput" 
            placeholder="Type your question or use microphone..." 
            disabled
            onkeypress="if(event.key === 'Enter') sendChatMessage()"
          />
          <button onclick="sendChatMessage()" id="sendBtn" disabled>üí¨ Send</button>
        </div>
        
        <div class="button-row">
          <button class="btn" id="speakBtn" disabled>
            üé§ Hold to Talk
          </button>
          <button class="btn" id="stopBtn" style="background: #ef4444;" disabled onclick="stopAvatar()">
            üõë Stop Avatar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000';
    const USER_ID = 'user_' + Math.random().toString(36).substr(2, 9);
    
    let room = null;
    let mediaRecorder;
    let audioChunks = [];
    let sessionReady = false;
    let currentSessionId = null;
    let isProcessing = false;
    let audioEnabled = false;

    console.log('üÜî User ID:', USER_ID);
    console.log('‚ö° Audio autoplay requires user interaction (Chrome policy)');

    document.addEventListener('DOMContentLoaded', () => {
      setupSpeakButton();
      setupClickToEnableAudio();
      startAvatar();
    });

    function setupClickToEnableAudio() {
      const overlay = document.getElementById('clickOverlay');
      
      const enableAudio = async (e) => {
        // Prevent this from triggering other clicks
        e.stopPropagation();
        
        console.log('üñ±Ô∏è User clicked - enabling audio...');
        
        const videoEl = document.getElementById('avatarVideo');
        const audioEl = document.getElementById('audioElement');
        
        try {
          // Unmute and play video
          videoEl.muted = false;
          videoEl.volume = 1.0;
          await videoEl.play().catch(() => {});
          
          // Play audio element (critical for avatar voice)
          audioEl.volume = 1.0;
          await audioEl.play();
          
          console.log('‚úÖ Audio enabled successfully!');
          
          audioEnabled = true;
          overlay.classList.remove('active');
          overlay.style.display = 'none';
          updateStatus('Avatar ready!', true);
          
          // Enable controls
          document.getElementById('speakBtn').disabled = false;
          document.getElementById('chatInput').disabled = false;
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('stopBtn').disabled = false;
          
          // Send welcome message
          if (!sessionReady) {
            sessionReady = true;
            sendWelcomeMessage();
          }
          
          // Remove listener
          overlay.removeEventListener('click', enableAudio);
          
        } catch (e) {
          console.error('‚ùå Audio enable failed:', e);
          updateStatus('Click again to enable audio', false);
        }
      };
      
      // Add click listener to overlay
      overlay.addEventListener('click', enableAudio);
    }

    function addChatMessage(text, type = 'system') {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        ${text}
        <span class="message-time">${timeStr}</span>
      `;
      
      chatMessages.appendChild(messageDiv);
      
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 50);
      
      return messageDiv;
    }

    function updateStatus(text, active = false) {
      document.getElementById('statusText').textContent = text;
      const dot = document.getElementById('statusDot');
      if (active) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
      console.log('Status:', text);
    }

    function showLoader(show = true) {
      const loader = document.getElementById('loader');
      const icon = document.querySelector('.video-placeholder .icon');
      
      if (show) {
        loader.classList.add('active');
        icon.style.display = 'none';
      } else {
        loader.classList.remove('active');
        icon.style.display = 'block';
      }
    }

    function updatePlaceholder(title, text) {
      document.getElementById('placeholderTitle').textContent = title;
      document.getElementById('placeholderText').textContent = text;
    }

    async function startAvatar() {
      try {
        updateStatus('Initializing...', false);
        updatePlaceholder('Starting...', 'Please wait...');
        showLoader(true);
        addChatMessage('Initializing avatar...', 'system');

        console.log('Creating session...');

        const response = await fetch(`${API_URL}/api/start-avatar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: USER_ID })
        });

        const sessionData = await response.json();
        if (!sessionData.success) {
          throw new Error(sessionData.error);
        }
        
        currentSessionId = sessionData.sessionId;
        
        console.log('‚úÖ Session created');
        
        updateStatus('Connecting...', false);
        updatePlaceholder('Connecting...', 'Establishing connection...');
        
        await connectWithLiveKit(sessionData.url, sessionData.token);
        
        console.log('Starting session...');
        updateStatus('Starting...', false);
        
        const startResponse = await fetch(`${API_URL}/api/start-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: USER_ID })
        });

        const startResult = await startResponse.json();
        if (!startResult.success) {
          throw new Error(startResult.error);
        }

        console.log('‚úÖ Session started');
        updateStatus('Loading video...', false);

      } catch (error) {
        console.error('‚ùå Error:', error);
        addChatMessage('Error: ' + error.message, 'system');
        updateStatus('Error: ' + error.message, false);
        updatePlaceholder('Error', error.message);
        showLoader(false);
      }
    }

    async function connectWithLiveKit(url, token) {
      room = new LivekitClient.Room({
        adaptiveStream: true,
        dynacast: true,
        videoCaptureDefaults: {
          resolution: LivekitClient.VideoPresets.h720.resolution,
        }
      });

      room.on(LivekitClient.RoomEvent.Connected, () => {
        console.log('‚úÖ LiveKit connected');
      });

      room.on(LivekitClient.RoomEvent.TrackSubscribed, async (track, publication, participant) => {
        console.log(`üì∫ Track subscribed: ${track.kind}`);
        
        if (track.kind === LivekitClient.Track.Kind.Video) {
          const videoEl = document.getElementById('avatarVideo');
          track.attach(videoEl);
          
          videoEl.style.display = 'block';
          document.getElementById('videoPlaceholder').classList.add('hidden');
          showLoader(false);
          
          // Start muted (required for autoplay)
          videoEl.muted = true;
          
          try {
            await videoEl.play();
            console.log('‚úÖ Video playing (muted)');
            updateStatus('Click to enable audio', false);
            
            // Show overlay to enable audio
            const overlay = document.getElementById('clickOverlay');
            overlay.classList.add('active');
            overlay.style.display = 'flex';
            
          } catch (e) {
            console.error('‚ùå Video play failed:', e);
          }
        }
        
        if (track.kind === LivekitClient.Track.Kind.Audio) {
          const audioEl = document.getElementById('audioElement');
          track.attach(audioEl);
          audioEl.volume = 1.0;
          console.log('‚úÖ Audio track attached (waiting for user interaction)');
        }
      });

      room.on(LivekitClient.RoomEvent.Disconnected, () => {
        console.log("üîå Disconnected");
        resetUI();
      });

      try {
        await room.connect(url, token);
        console.log('‚úÖ Room connected');
      } catch (error) {
        console.error('‚ùå Connect failed:', error);
        throw error;
      }
    }

    async function sendWelcomeMessage() {
      try {
        console.log('üëã Getting welcome message...');
        
        const response = await fetch(`${API_URL}/api/session-ready`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: USER_ID })
        });
        
        const result = await response.json();
        if (result.success && result.welcomeText) {
          console.log('‚úÖ Welcome message sent');
          addChatMessage(result.welcomeText, 'avatar');
        }
      } catch (error) {
        console.error('‚ùå Welcome failed:', error);
      }
    }

    function setupSpeakButton() {
      const speakBtn = document.getElementById('speakBtn');

      const startRecording = async () => {
        if (speakBtn.disabled || isProcessing) return;
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
              sampleRate: 16000
            } 
          });
          
          const options = { 
            mimeType: 'audio/webm;codecs=opus',
            audioBitsPerSecond: 16000
          };
          
          mediaRecorder = new MediaRecorder(stream, options);
          audioChunks = [];
          
          mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
              const base64Audio = reader.result.split(',')[1];
              await sendAudioToServer(base64Audio);
            };
            stream.getTracks().forEach(track => track.stop());
          };

          mediaRecorder.start();
          speakBtn.textContent = 'üî¥ Listening...';
          speakBtn.classList.add('recording');
          console.log('üé§ Recording...');

        } catch (err) {
          console.error("Microphone error:", err);
          alert("Could not access microphone.");
        }
      };

      const stopRecording = () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          speakBtn.textContent = '‚è≥ Processing...';
          speakBtn.classList.remove('recording');
          console.log('üé§ Processing...');
        }
      };
      
      speakBtn.addEventListener('mousedown', startRecording);
      speakBtn.addEventListener('mouseup', stopRecording);
      speakBtn.addEventListener('mouseleave', stopRecording);
      
      speakBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startRecording();
      });
      speakBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopRecording();
      });
    }

    async function sendAudioToServer(audioBase64) {
      const speakBtn = document.getElementById('speakBtn');
      
      if (isProcessing) {
        console.log('‚ö†Ô∏è Already processing');
        speakBtn.textContent = 'üé§ Hold to Talk';
        return;
      }
      
      isProcessing = true;
      const thinkingMsg = addChatMessage('ü§î Thinking...', 'system');
      
      try {
        console.log('üó£Ô∏è Sending audio...');
        const startTime = Date.now();
        
        const response = await fetch(`${API_URL}/api/speak`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: USER_ID,
            audioData: audioBase64
          })
        });

        const result = await response.json();
        const totalTime = Date.now() - startTime;
        
        if (thinkingMsg) {
          thinkingMsg.remove();
        }
        
        if (!result.success) {
          console.log('‚ùå Error:', result.error);
          addChatMessage('Error: ' + result.error, 'system');
        } else {
          console.log(`‚úÖ Response in ${totalTime}ms`);
          addChatMessage(result.transcribedText, 'user');
          addChatMessage(result.avatarResponse, 'avatar');
        }
        
      } catch (error) {
        if (thinkingMsg) {
          thinkingMsg.remove();
        }
        console.log('‚ùå Error:', error.message);
        addChatMessage('Network error occurred', 'system');
      } finally {
        isProcessing = false;
        speakBtn.textContent = 'üé§ Hold to Talk';
        speakBtn.classList.remove('recording');
      }
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || isProcessing) return;
      
      isProcessing = true;
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      const thinkingMsg = addChatMessage('ü§î Thinking...', 'system');
      
      try {
        console.log('üí¨ Sending:', message);
        addChatMessage(message, 'user');
        input.value = '';
        
        const startTime = Date.now();
        
        const response = await fetch(`${API_URL}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: USER_ID,
            message: message
          })
        });

        const result = await response.json();
        const totalTime = Date.now() - startTime;
        
        if (thinkingMsg) {
          thinkingMsg.remove();
        }
        
        if (result.success) {
          console.log(`ü§ñ Response in ${totalTime}ms`);
          addChatMessage(result.avatarResponse, 'avatar');
        } else {
          console.log('‚ùå Error:', result.error);
          addChatMessage('Error: ' + result.error, 'system');
        }
        
      } catch (error) {
        if (thinkingMsg) {
          thinkingMsg.remove();
        }
        console.log('‚ùå Error:', error.message);
        addChatMessage('Could not send message', 'system');
      } finally {
        isProcessing = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'üí¨ Send';
      }
    }

    async function stopAvatar() {
      if (!currentSessionId) {
        console.log('‚ö†Ô∏è No active session to stop');
        return;
      }

      const stopBtn = document.getElementById('stopBtn');
      stopBtn.disabled = true;
      stopBtn.textContent = '‚è≥ Stopping...';

      try {
        console.log('üõë Stopping avatar session...');
        addChatMessage('Stopping avatar session...', 'system');

        // Call server to end session
        const response = await fetch(`${API_URL}/api/close-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: USER_ID })
        });

        const result = await response.json();
        
        if (result.success) {
          console.log('‚úÖ Session stopped gracefully');
          addChatMessage('‚úÖ Session stopped successfully', 'system');
        } else {
          console.log('‚ö†Ô∏è Server stop warning:', result.message);
        }

        // Disconnect LiveKit room
        if (room) {
          await room.disconnect();
          room = null;
          console.log('‚úÖ LiveKit disconnected');
        }

        // Clean up UI
        resetUI();

      } catch (error) {
        console.error('‚ùå Error stopping avatar:', error);
        addChatMessage('‚ö†Ô∏è Error stopping session: ' + error.message, 'system');
        
        // Force cleanup even on error
        if (room) {
          try {
            await room.disconnect();
          } catch (e) {
            console.error('Error disconnecting room:', e);
          }
          room = null;
        }
        resetUI();
      }
    }

    function resetUI() {
      sessionReady = false;
      currentSessionId = null;
      isProcessing = false;
      audioEnabled = false;
      
      const videoEl = document.getElementById('avatarVideo');
      videoEl.srcObject = null;
      videoEl.style.display = 'none';
      
      const audioEl = document.getElementById('audioElement');
      audioEl.srcObject = null;
      
      document.getElementById('videoPlaceholder').classList.remove('hidden');
      updatePlaceholder('Session Ended', 'Refresh page to reconnect');
      showLoader(false);
      
      updateStatus('Disconnected', false);
      
      document.getElementById('speakBtn').disabled = true;
      document.getElementById('chatInput').disabled = true;
      document.getElementById('chatInput').value = '';
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('stopBtn').textContent = 'üõë Stop Avatar';
      
      console.log('Session ended');
      addChatMessage('Session ended. Refresh to restart.', 'system');
    }
  </script>
</body>
</html>